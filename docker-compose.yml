services:
  # Nginx - входная точка, reverse proxy
  nginx:
    image: nginx:1.27-alpine
    container_name: nginx
    ports:
      - "80:80"
      - "443:443"  # HTTPS
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./frontend/dist:/usr/share/nginx/html:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro  # SSL сертификаты
    depends_on:
      - postgres
    networks:
      - frontend_network
      - backend_network
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # PostgreSQL - база данных
  postgres:
    image: postgres:16-alpine
    container_name: postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-app_db}
      POSTGRES_USER: ${POSTGRES_USER:-app_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - backend_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-app_user}"]
      interval: 10s
      timeout: 5s
      retries: 5
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # pgAdmin - веб-интерфейс для управления PostgreSQL
  # Включен только в dev профиле (для администрирования БД)
  pgadmin:
    profiles: ["dev"]
    image: dpage/pgadmin4:8.2
    container_name: pgadmin
    ports:
      - "5050:80"
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - postgres
    networks:
      - backend_network
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # Docker Registry - приватный регистр образов
  # Включен только в dev профиле
  registry:
    profiles: ["dev"]
    image: registry:2
    container_name: registry
    ports:
      - "5000:5000"
    environment:
      REGISTRY_AUTH: htpasswd
      REGISTRY_AUTH_HTPASSWD_REALM: Registry Realm
      REGISTRY_AUTH_HTPASSWD_PATH: /auth/htpasswd
      REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY: /var/lib/registry
    volumes:
      - registry_data:/var/lib/registry
      - ./registry/auth:/auth:ro
    networks:
      - backend_network
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

  # Watchtower - автообновление контейнеров
  # Используется форк nickfedor/watchtower (совместим с Docker 29, API 1.44+)
  watchtower:
    image: nickfedor/watchtower:latest
    container_name: watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      WATCHTOWER_CLEANUP: "true"
      WATCHTOWER_POLL_INTERVAL: 300  # Проверка каждые 5 минут
      WATCHTOWER_LABEL_ENABLE: "true"  # Обновлять только контейнеры с label
    networks:
      - backend_network
    restart: unless-stopped

  # Backend - FastAPI application
  backend:
    build: ./backend
    container_name: backend
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      SECRET_KEY: ${SECRET_KEY}
    networks:
      - backend_network
    depends_on:
      - postgres
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

networks:
  frontend_network:
    driver: bridge
  backend_network:
    driver: bridge
    internal: false  # false для доступа к registry извне на этапе разработки

volumes:
  postgres_data:
    driver: local
  pgadmin_data:
    driver: local
  registry_data:
    driver: local
